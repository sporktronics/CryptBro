/*

  #### #### #  # #### ##### ###  #### ####
  #    #  # #  # #  #   #   #  # #  # #  #
  #    #  # #### #  #   #   ###  #  # #  #
  #    ###     # ####   #   #  # ###  #  #
  #### # ## #### #      #   ###  # ## ####

  (c) 2012 Sporktronics, LLC
  http://www.sporktronics.com/

  Licensed under the GNU GPL, version 2
  http://www.gnu.org/licenses/gpl-2.0.html

*/var CryptBro=CryptBro||{};CryptBro.server=CryptBro.server||{},function(){var a=this;CryptBro.version="1.0 Release Candidate 1 (2012030901)",CryptBro.encrypt=function(b,c,d,e){function g(b,c,d){var e=Crypto.AES.encrypt(c,b),f=a._hmac(b,e),g={m:e,s:d,h:f};return a._encode(g)}if(!d){var f=a._stretchKey(b);return g(f.key,c,f.salt)}return a._stretchKey(b,undefined,function(a){d(g(a.key,c,a.salt))},e),!0},a._encode=function(a){return window.btoa(Deflate.deflate(JSON.stringify(a)))},a._decode=function(a){try{return JSON.parse(Deflate.inflate(window.atob(a)))}catch(b){throw new Error("Input is in wrong format")}},CryptBro.decrypt=function(b,c,d,e){try{var f=a._decode(c),c=f.m,g=f.s,h=function(b,c){var d=a._hmac(b,c);return d!=f.h?!1:Crypto.AES.decrypt(c,b)};if(!d){var i=a._stretchKey(b,g);return h(i.key,c,g)}a._stretchKey(b,g,function(a){d(h(a.key,c))},e)}catch(j){throw j}},a._hmac=function(a,b){return Crypto.util.bytesToBase64(Crypto.HMAC(Crypto.SHA1,b,a,{asBytes:!0}))},a._stretchKey=function(a,b,c,d){var e=20;return b?b=Crypto.util.base64ToBytes(b):b=Crypto.util.randomBytes(16),c?(Crypto.PBKDF2Async(a,b,64,function(a){a=Crypto.util.bytesToBase64(Crypto.util.hexToBytes(a)),c({key:a,salt:Crypto.util.bytesToBase64(b)})},{iterations:e,onProgressChange:d}),!0):(a=Crypto.PBKDF2(a,b,64,{iterations:e}),a=Crypto.util.bytesToBase64(Crypto.util.hexToBytes(a)),{key:a,salt:Crypto.util.bytesToBase64(b)})},CryptBro.util={encode:a._encode,decode:a._decode}}();var CryptBro=CryptBro||{};CryptBro.server=CryptBro.server||{},function(){var a=this;SSRPC.onError(function(a){console.log("error: ",a.name,a.message)}),SSRPC.onInfo(function(a){console.log("info: ",a.name,a.message)}),SSRPC.onWarn(function(a){console.log("warn: ",a.name,a.message)}),SSRPC.onData(function(a){console.log("data: ",a.name,a.message)}),a._serverUrl="cryptbro.server.php",CryptBro.server.url=function(b){return b!==undefined&&(a._serverUrl=b),a._serverUrl},CryptBro.server.hello=function(){SSRPC.cmd("hello",{info:"CryptBro, v0.8 beta (embryo build)"},a._serverUrl)},CryptBro.server.login=function(b,c){SSRPC.cmd("login",{user:b,pass:c},a._serverUrl)},CryptBro.server.logout=function(){SSRPC.cmd("logout","",a._serverUrl)},CryptBro.server.register=function(b,c,d){SSRPC.cmd("register",{user:b,pass:c,email:d},a._serverUrl)},CryptBro.server.updateInfo=function(b,c){SSRPC.cmd("updateInfo",{pass:b,email:c},a._serverUrl)},CryptBro.server.save=function(b,c,d){SSRPC.cmd("save",{message:b,expires:c,to:d},a._serverUrl)},CryptBro.server.retrieve=function(b,c){SSRPC.cmd("retrieve",{id:b},a._serverUrl,undefined,c)},CryptBro.server.inbox=function(){SSRPC.cmd("inbox","",a._serverUrl)}}();var CryptBro=CryptBro||{};CryptBro.ui=CryptBro.ui||{},function(){var a=this;CryptBro.server.hello(),a._loggedInUser=undefined,a._hash=window.location.hash,a._lastHash=null,a._ignoreNextHash=!1,a._messageHash=window.location.hash||"",a._messageHash.substr(0,3)!=="#l!"&&a._messageHash.substr(0,3)!=="#b!"&&(a._messageHash=undefined,window.location.hash=""),$.mobile.ajaxEnabled=!1,$.mobile.hashListeningEnabled=!1,CryptBro.ui.page=function(b){$.mobile.changePage("#"+b,{changeHash:!1}),$("input#key").val(""),b==="message"?window.location.hash=a._messageHash||"":(window.location.hash="#"+b,b=="inbox"&&(CryptBro.ui.loadingMsg("loading"),CryptBro.server.inbox()))},CryptBro.ui.getCryptMethod=function(){return $('button#encrypt[data-theme="b"], button#decrypt[data-theme="b"]').first().attr("id")},CryptBro.ui.setCryptMethod=function(a){CryptBro.ui.getCryptMethod()!==a&&CryptBro.ui.cryptToggle()},CryptBro.ui.cryptToggle=function(){$('div#cryptmethod div[data-theme="a"]').attr("data-theme","c").removeClass("ui-btn-up-a").addClass("ui-btn-up-b"),$('div#cryptmethod div[data-theme="b"]').attr("data-theme","a").removeClass("ui-btn-up-b").addClass("ui-btn-up-a"),$('div#cryptmethod div[data-theme="c"]').attr("data-theme","b"),$('div#cryptmethod button[data-theme="a"]').attr("data-theme","c"),$('div#cryptmethod button[data-theme="b"]').attr("data-theme","a"),$('div#cryptmethod button[data-theme="c"]').attr("data-theme","b"),$("div#cryptmethod button").off("click"),$('div#cryptmethod button[data-theme="a"]').click(CryptBro.ui.cryptToggle)},CryptBro.ui.loadingMsg=function(a){$.mobile.showPageLoadingMsg("a",a,!0),$(".ui-loader-textonly").removeClass("ui-loader-textonly")},CryptBro.ui.doRetrieve=function(){a._hash.substr(0,3)==="#l!"?(a._messageHash=a._hash,a._loggedInUser===undefined?CryptBro.ui.page("login"):a._retrieve(a._hash.substr(3))):a._hash.substr(0,3)==="#b!"&&a._retrieve(a._hash.substr(3))},a._retrieve=function(b){a._messageHash=a._hash,CryptBro.ui.loadingMsg("retrieving"),CryptBro.server.retrieve(a._hash.substr(3),function(a){pct=Math.round(a.loaded/a.total*100),$.mobile.loadingMessage="retrieving ("+pct+"%)",$(".ui-loader.ui-body-a h1").text($.mobile.loadingMessage)})},CryptBro.ui.doSave=function(){var a=CryptBro.ui.getMessage(),b=CryptBro.ui.getOptions();a.message&&b.save&&(CryptBro.ui.loadingMsg("saving"),CryptBro.server.save(a.message,b.expires,a.to))},CryptBro.ui.doCrypt=function(){var a=CryptBro.ui.getCryptMethod(),b=CryptBro.ui.getMessage();if(b.key&&b.message){CryptBro.ui.loadingMsg(a+"ing");try{CryptBro[a](b.key,b.message,function(b){$.mobile.hidePageLoadingMsg(),b?($("textarea#message").val(b),$("textarea#message").keyup(),a==="encrypt"&&CryptBro.ui.doSave(),CryptBro.ui.cryptToggle()):CryptBro.ui.error("Wrong key")},function(b){$.mobile.loadingMessage=a+"ing ("+b+"%)",$(".ui-loader.ui-body-a h1").text($.mobile.loadingMessage)})}catch(c){$.mobile.hidePageLoadingMsg(),CryptBro.ui.error(c)}}else CryptBro.ui.error("Need a key and a message to "+a);return!1},CryptBro.ui.doReset=function(){$('input[type="text"], input[type="password"], textarea').val(""),$.mobile.changePage("#message",{changeHash:!1}),window.location.hash="",a._messageHash=undefined,CryptBro.ui.setCryptMethod("encrypt")},CryptBro.ui.getMessage=function(){return{key:$("input#key").val()===""?undefined:$("input#key").val(),to:$("input#to").val()===""?undefined:$("input#to").val(),message:$("textarea#message").val()===""?undefined:$("textarea#message").val()}},CryptBro.ui.getOptions=function(){return{save:$("select#save").val()==="yes",expires:parseInt($("select#expire").val())}},window.setInterval(function(){a._hash!==a._lastHash&&(console.log('New hash: "'+a._hash+'"'),a._ignoreNextHash?(a._ignoreNextHash=!1,console.log("Ignoring this hash")):CryptBro.ui.doRetrieve()),a._lastHash=a._hash,a._hash=window.location.hash},100),head.ready(function(){$("[data-role=footer]").fixedtoolbar({tapToggle:!1}),$("input#loginbutton").click(CryptBro.ui.login),$("input#registerbutton").click(CryptBro.ui.register),$('div#cryptmethod button[data-theme="a"]').click(CryptBro.ui.cryptToggle),$("button#crypt").click(CryptBro.ui.doCrypt),$("button#reset").click(CryptBro.ui.doReset),$("form#crypt").submit(CryptBro.ui.doCrypt),$("body.loading").removeClass("loading").addClass("ui-body-a"),$("div#version").text("CryptBro "+CryptBro.version)}),CryptBro.ui.getLoggedInUser=function(){return a._loggedInUser},CryptBro.ui.error=function(a){$("<div class='ui-loader ui-corner-all ui-body-d ui-loader-verbose ui-loader-textonly error'><h1>"+a+"</h1></div>").css({display:"block",opacity:.96,top:$(window).scrollTop()+100}).appendTo("body").delay(2500).fadeOut(400,function(){$(this).remove()})},CryptBro.ui.info=function(a){$("<div class='ui-loader ui-corner-all ui-body-e ui-loader-verbose ui-loader-textonly info'><h1>"+a+"</h1></div>").css({display:"block",opacity:.96,top:$(window).scrollTop()+100}).appendTo("body").delay(2500).fadeOut(400,function(){$(this).remove()})},CryptBro.ui.login=function(){return CryptBro.server.login($("input#username").val(),$("input#password").val()),!1},CryptBro.ui.register=function(){return $("input#rusername").val()&&$("input#rusername").val()&&$("input#rusername").val()?$("input#password1").val()===$("input#password2").val()?CryptBro.server.register($("input#rusername").val(),$("input#password1").val(),$("input#email").val()):CryptBro.ui.error("Passwords must match"):CryptBro.ui.error("Fill in all fields"),!1},CryptBro.ui.logout=function(){return CryptBro.server.logout(),!1},CryptBro.ui.onLogin=function(b){a._loggedInUser=b,CryptBro.ui.page("message"),$(".loggedout").hide(),$(".loggedin").show(),$("span.loginbutton").text("Logout"),$("a.login").click(CryptBro.ui.logout),$('input[type="text"], input[type="password"], textarea').val("")},CryptBro.ui.onLogout=function(b){b=b===undefined?!0:b,a._loggedInUser=undefined,$(".loggedin").hide(),$(".loggedout").show(),$("span.loginbutton").text("Login"),$("a.login").off("click"),b&&CryptBro.ui.doReset()},CryptBro.ui.msg=function(a){window.location.hash=a,CryptBro.ui.doRetrieve()},CryptBro.ui.createInbox=function(a){var b=$('<ul data-role="listview" data-theme="a" data-divider-theme="d"></ul>'),c=new Array;for(id in a)c.push(id);var d=c.sort(function(b,c){return a[b].date>a[c].date});for(id in d){var e=new Date(a[d[id]].date*1e3),f=e.toLocaleDateString()+" &mdash; "+(e.getHours()%12>0?e.getHours()%12:12)+":"+(e.getMinutes()<10?"0"+e.getMinutes():e.getMinutes())+" "+(e.getHours()-12<0?"AM":"PM");a[d[id]].to===undefined?b.prepend("<li><a href=\"javascript:CryptBro.ui.msg('#b!"+d[id]+"')\"><h3>"+f+"</h3><p>From: <b>"+a[d[id]].from+"</b> &#9654; <i>Anonymous</i></p></a></li>"):b.prepend("<li><a href=\"javascript:CryptBro.ui.msg('#l!"+d[id]+"')\"><h3>"+f+"</h3><p>From: <b>"+a[d[id]].from+"</b> &#9654; To: <b>"+a[d[id]].to+"</b></p></a></li>")}return b},SSRPC.onData(function(b){$.mobile.hidePageLoadingMsg();switch(b.name){case"login":CryptBro.ui.onLogin(b.message);break;case"logout":b.message=="notLoggedIn"?CryptBro.ui.onLogout(!1):CryptBro.ui.onLogout();break;case"register":CryptBro.ui.page("login");break;case"retrieve":CryptBro.ui.setCryptMethod("decrypt"),$("textarea#message").val(b.message.message),$("textarea#message").keyup(),a._loggedInUser!==undefined&&(b.message.to!==undefined&&b.message.to!==a._loggedInUser?$("input#to").val(b.message.to):b.message.from!==undefined&&b.message.from!==a._loggedInUser&&$("input#to").val(b.message.from)),$.mobile.changePage("#message",{changeHash:!1});break;case"save":var c=CryptBro.ui.getMessage();a._ignoreNextHash=!0,c.to?window.location.hash="#l!"+b.message:window.location.hash="#b!"+b.message;break;case"inbox":$("div#inboxmessages").html(CryptBro.ui.createInbox(b.message)),$("div#inboxmessages ul").listview();break;case"hello":break;default:CryptBro.ui.info("Unhandled data: "+b.name)}}),SSRPC.onError(function(a){$.mobile.hidePageLoadingMsg(),CryptBro.ui.error(a.message)}),SSRPC.onWarn(function(a){$.mobile.hidePageLoadingMsg(),CryptBro.ui.error(a.message)}),SSRPC.onInfo(function(a){$.mobile.hidePageLoadingMsg(),CryptBro.ui.info(a.message)})}();